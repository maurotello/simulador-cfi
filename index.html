<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Cuotas CFI – UEP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0f192d 0%, #1a2942 100%);
      color: #fff;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: left;
    }

    h1 {
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      margin-right: 20px;
      color: #ffffff;
    }

    .page-header>p {
      margin: 0;
      opacity: 0.9;
      align-self: center;
    }

    .header-text-group {
      display: flex;
      flex-direction: column;
      justify-content: center;
      margin-left: 20px;
    }

    .header-text-group h1 {
      margin-bottom: 0px;
    }

    .header-text-group p {
      margin-top: 0px;
    }

    h2 {
      font-size: 1.5rem;
      margin: 1rem 0;
      color: #00b4d8;
      font-weight: 600;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      margin-bottom: 24px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 48px rgba(0, 180, 216, 0.15);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    @media (max-width: 550px) {
      .grid {
        grid-template-columns: 1fr !important;
      }
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      color: #0f192d;
    }

    input,
    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 2px solid #e0e0e6;
      font-size: 0.95rem;
      box-sizing: border-box;
      transition: all 0.3s ease;
      background: #fff;
      color: #0f192d;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #00b4d8;
      box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.1);
    }

    button {
      background: linear-gradient(135deg, #0096c7 0%, #00b4d8 100%);
      color: #fff;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      margin-right: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 150, 199, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 180, 216, 0.4);
      background: linear-gradient(135deg, #0077b6 0%, #0096c7 100%);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .secondary {
      background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
      box-shadow: 0 4px 12px rgba(73, 80, 87, 0.3);
    }

    .secondary:hover {
      background: linear-gradient(135deg, #343a40 0%, #495057 100%);
    }

    .help {
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 4px;
      line-height: 1.4;
    }

    .help-uso-interno {
      font-size: 1.2rem;
      color: #6c757d;
      margin-top: 4px;
      margin-bottom: 35px;
      line-height: 1.4;
    }

    .help-lineas {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 20px;
      margin-bottom: 10px;
      line-height: 1;
    }

    .help-ultima-linea {
      margin-bottom: 30px;
    }

    .error {
      color: #dc3545;
      font-size: 0.9rem;
      margin-top: 12px;
      padding: 12px;
      background: rgba(220, 53, 69, 0.1);
      border-radius: 8px;
      border-left: 4px solid #dc3545;
      display: none;
    }

    .error:not(:empty) {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.85rem;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    th,
    td {
      border: 1px solid #e9ecef;
      padding: 12px 10px;
      text-align: right;
      white-space: nowrap;
      color: #0f192d;
    }

    th {
      background: linear-gradient(135deg, #0f192d 0%, #1a2942 100%);
      color: #fff;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
    }

    th:first-child,
    td:first-child {
      text-align: center;
    }

    tbody tr:hover {
      background: rgba(0, 180, 216, 0.05);
    }

    tfoot td {
      font-weight: 700;
      background: #f8f9fa;
      color: #0f192d;
      border-top: 2px solid #00b4d8;
    }

    @media (max-width: 768px) {
      table {
        font-size: 0.75rem;
      }

      th,
      td {
        padding: 8px 6px;
      }
    }

    .summary {
      font-size: 0.9rem;
      margin-top: 12px;
      line-height: 1.6;
      padding: 16px;
      background: rgba(0, 180, 216, 0.05);
      border-radius: 8px;
      border-left: 4px solid #00b4d8;
      color: #0f192d;
    }

    .note {
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }

      h1 {
        font-size: 1.6rem;
      }

      .card {
        padding: 20px;
      }

      button {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }
    }

    @media print {
      body {
        background: #fff;
        padding: 0;
      }

      .card {
        box-shadow: none;
        border-radius: 0;
      }

      button,
      #error {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .page-header {
        flex-direction: column;
        text-align: center;
        padding: 20px 10px;
      }

      .page-header>div {
        margin: 0 !important;
        width: 100%;
        justify-content: center !important;
        display: flex;
      }

      .header-text-group {
        margin-left: 0 !important;
        margin-top: 15px;
        align-items: center;
      }

      .header-text-group h1 {
        font-size: 1.4rem;
        text-align: center;
      }
    }

    @media (max-width: 768px) {
      thead {
        display: none;
      }

      table,
      tbody,
      tfoot,
      th,
      td,
      tr {
        display: block;
        width: 100%;
        box-sizing: border-box;
      }

      tbody tr {
        margin-bottom: 20px;
        background: #fff;
        border: 1px solid #e0e0e6;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: right;
        padding: 12px 15px;
        border: none;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
      }

      td:last-child {
        border-bottom: none;
      }

      td::before {
        content: attr(data-label);
        font-weight: 700;
        color: #6c757d;
        text-transform: uppercase;
        font-size: 0.75rem;
        text-align: left;
        margin-right: 15px;
      }

      tfoot tr {
        margin-top: 20px;
        border: 2px solid #00b4d8;
        border-radius: 12px;
        background: #f8f9fa;
      }

      tfoot td:empty {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="page-header">
      <div style="display: flex; align-items: center; margin-right: auto;">
        <h1>
          <img
            src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxzdmcgaWQ9IkNhcGFfMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiANCiAgICAgd2lkdGg9IjM1MCIgDQogICAgIGhlaWdodD0iMTIwIiANCiAgICAgdmlld0JveD0iMCAwIDU3NC4yNiAyMTMuNDQiPg0KICA8ZGVmcz4NCiAgICA8c3R5bGU+LmNscy0xLC5jbHMtMntmaWxsOm5vbmU7c3Ryb2tlOiNmZmY7c3Ryb2tlLW1pdGVybGltaXQ6MTA7c3Ryb2tlLXdpZHRoOjUuNHB4O30uY2xzLTN7ZmlsbDojZmZmO30uY2xzLTJ7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7fTwvc3R5bGU+DQogIDwvZGVmcz4NCiAgPGcgaWQ9IkxheWVyXzEiPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTI2OC41LDk5LjA4Yy0uOTguNDMtMi44Ni43Ny01LjE3Ljc3LTguODQsMC0xMy4wMy02Ljc4LTEzLjAzLTE2LDAtMTIuMiw3LjIxLTE2Ljk2LDEzLjktMTYuOTYsMi4zNCwwLDMuOTguNDMsNC42NS44N2wtMS4xMiw1LjI5Yy0uNzctLjM0LTEuNjMtLjYzLTMuMTItLjYzLTMuNzgsMC03LjIxLDMuMDctNy4yMSwxMS4xczMuMTIsMTAuNzcsNy4yMSwxMC43N2MxLjEyLDAsMi40MS0uMjQsMy4yMi0uNDlsLjY3LDUuMjlaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNMjkyLjk2LDgyLjc5YzAsMTIuMjEtNC42LDE3LjE1LTExLjE0LDE3LjE1LTcuODIsMC0xMC44OC03Ljc4LTEwLjg4LTE2LjY3czMuNzMtMTYuNDgsMTEuNC0xNi40OGM4LjI4LDAsMTAuNjMsOC42LDEwLjYzLDE1Ljk5Wk0yNzcuODksODMuMzdjMCw3LjM0LDEuNDgsMTEuMSw0LjE5LDExLjEsMi44NiwwLDMuOTMtNC44LDMuOTMtMTEuMzksMC01LjY3LS45Mi0xMC44LTMuOTktMTAuOC0yLjY1LDAtNC4xMyw0LjEzLTQuMTMsMTEuMVoiLz4NCiAgICA8cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik0yOTguMjIsOTkuNTZ2LTMyLjM4aDYuMTRsNS4zMSwxMi42OGMxLjA3LDIuNDksMi43MSw2LjY3LDMuNjgsOS40NmguMWMtLjIxLTMuNDEtLjY3LTkuMDMtLjY3LTE0Ljk4di03LjE2aDUuODh2MzIuMzhoLTYuMTNsLTUuMjYtMTIuM2MtMS4xNy0yLjc0LTIuNzEtNi44Ny0zLjUzLTkuNzVoLS4xYy4yLDMuMjcuNDYsOC4yNi40NiwxNC44djcuMjVoLTUuODhaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNMzI0LjYsOTMuMTJjMS4zOC43MiwzLjc5LDEuMjUsNS42NywxLjI1LDMuMTIsMCw0LjctMS41NCw0LjctMy42NSwwLTIuMzUtMS41My0zLjUtNC40NS01LjI4LTQuNy0yLjY5LTYuNDktNi4xLTYuNDktOS4wMywwLTUuMTgsMy42OC05LjUxLDEwLjgzLTkuNTEsMi4zLDAsNC40NS41OCw1LjQyLDEuMTVsLTEuMDcsNS40M2MtLjk3LS41OC0yLjQ2LTEuMTEtNC4zNS0xLjExLTIuODYsMC00LjI0LDEuNjMtNC4yNCwzLjM3LDAsMS45MSwxLjAyLDIuOTIsNC43LDUuMDQsNC42LDIuNTksNi4yMyw1Ljg2LDYuMjMsOS4yNywwLDUuOTEtNC42NSw5LjgtMTEuMzQsOS44LTIuNzYsMC01LjQyLS42OC02LjU5LTEuM2wuOTctNS40MloiLz4NCiAgICA8cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik0zNjAuNzksODUuMzRoLTcuODJ2OC43NGg4Ljg0djUuNDhoLTE1LjUzdi0zMi4zOGgxNC45N3Y1LjQ4aC04LjI4djcuNDRoNy44MnY1LjI0WiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTM3MS4zNiw2Ny4xOGg2LjY5djIyLjA1YzAsOS4zMS00LjgxLDEwLjcxLTkuNjYsMTAuNzEtMS4zOCwwLTIuNjYtLjE5LTMuMzctLjQ4bC41Ny01LjI4Yy42MS4xOSwxLjMzLjIzLDIuMi4yMywxLjk0LDAsMy41OC0uNzIsMy41OC00Ljl2LTIyLjM0WiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTQwNC45OSw4Mi43OWMwLDEyLjIxLTQuNiwxNy4xNS0xMS4xNCwxNy4xNS03LjgyLDAtMTAuODgtNy43OC0xMC44OC0xNi42N3MzLjczLTE2LjQ4LDExLjQtMTYuNDhjOC4yOCwwLDEwLjYzLDguNiwxMC42MywxNS45OVpNMzg5LjkxLDgzLjM3YzAsNy4zNCwxLjQ5LDExLjEsNC4yLDExLjEsMi44NiwwLDMuOTMtNC44LDMuOTMtMTEuMzksMC01LjY3LS45Mi0xMC44LTMuOTktMTAuOC0yLjY1LDAtNC4xNCw0LjEzLTQuMTQsMTEuMVoiLz4NCiAgICA8cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik00MjAuNDIsNjcuMThoMTQuOTd2NS40OGgtOC4yOHY4LjMxaDcuNzd2NS4yM2gtNy43N3YxMy4zNmgtNi42OXYtMzIuMzhaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNNDU1LjA3LDg1LjM0aC03LjgxdjguNzRoOC44NHY1LjQ4aC0xNS41NHYtMzIuMzhoMTQuOTd2NS40OGgtOC4yOHY3LjQ0aDcuODF2NS4yNFoiLz4NCiAgICA8cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik00NjEuNTgsNjcuNjZjMS42OS0uMzksNC4xNC0uNjIsNi43OS0uNjIsNC4zNSwwLDcuMzYuOTYsOS41NiwyLjg4LDIuOTYsMi41LDQuNSw2Ljc3LDQuNSwxMy4wN3MtMS43OSwxMS4yLTQuODEsMTMuNjljLTIuMzUsMi4wNy01LjcyLDMuMTItMTAuNDcsMy4xMi0yLjE0LDAtNC4yNC0uMTktNS41Ny0uMzl2LTMxLjc1Wk00NjguMjcsOTQuNTZjLjM2LjA5LjgyLjA5LDEuMTguMDksMy4yMSwwLDYuMDMtMi45OCw2LjAzLTExLjkxLDAtNi42My0xLjg0LTEwLjY2LTUuODctMTAuNjYtLjQ2LDAtLjkyLDAtMS4zMy4xNHYyMi4zNFoiLz4NCiAgICA8cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik01MDIuMTIsODUuMzRoLTcuODJ2OC43NGg4Ljg0djUuNDhoLTE1LjU0di0zMi4zOGgxNC45N3Y1LjQ4aC04LjI4djcuNDRoNy44MnY1LjI0WiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTUwOC42Miw2Ny42NmMyLjEtLjM5LDQuNzUtLjYyLDcuMzEtLjYyLDMuNjgsMCw3LC41Myw5LjIsMi40LDIuMSwxLjc4LDIuNzYsMy45NCwyLjc2LDYuNzMsMCwzLjQ2LTEuODQsNi41OC01LjMxLDguMDd2LjA5YzIuMzUuOTIsMy41MywyLjkzLDQuMTksNi40NC42NywzLjYsMS41OSw3LjU5LDIuMiw4Ljc5aC03Yy0uNDYtLjkxLTEuMjItNC4xOC0xLjc0LTcuNzgtLjYxLTMuOTgtMS42OS01LjE0LTMuODgtNS4xNGgtMS4wMnYxMi45MmgtNi43di0zMS44OVpNNTE1LjMyLDgxLjc4aDEuMjNjMi45MSwwLDQuNTUtMi4yMSw0LjU1LTUuMDRzLTEuMTgtNC43MS00LjE0LTQuODFjLS42MSwwLTEuMjguMDUtMS42My4ydjkuNjVaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNNTQwLjE2LDkyLjE2bC0xLjUzLDcuNGgtNi40OWw3LjQ2LTMyLjM4aDguMDJsNi43LDMyLjM4aC02LjQ5bC0xLjQ4LTcuNGgtNi4xOFpNNTQ1LjczLDg3LjI2bC0xLjEyLTYuNzdjLS4zNi0xLjk3LS44Mi01LjI0LTEuMTItNy4zNWgtLjE2Yy0uMzYsMi4xNi0uODcsNS40OC0xLjIzLDcuMzVsLTEuMjgsNi43N2g0LjkxWiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTU1OC43OCw2Ny4xOGg2LjY5djI3LjA0aDguNzl2NS4zM2gtMTUuNDh2LTMyLjM4WiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTI1MS45OSwxMTUuN2MxLjY4LS4zOSw0LjE0LS42Myw2Ljc5LS42Myw0LjM0LDAsNy4zNi45Niw5LjU2LDIuODgsMi45NiwyLjUsNC41LDYuNzcsNC41LDEzLjA3cy0xLjc5LDExLjE5LTQuOCwxMy42OWMtMi4zNSwyLjA3LTUuNzIsMy4xMi0xMC40NywzLjEyLTIuMTQsMC00LjI0LS4yLTUuNTctLjM5di0zMS43NFpNMjU4LjY4LDE0Mi41OWMuMzYuMS44Mi4xLDEuMTguMSwzLjIyLDAsNi4wMy0yLjk4LDYuMDMtMTEuOTIsMC02LjYyLTEuODQtMTAuNjYtNS44OC0xMC42Ni0uNDYsMC0uOTIsMC0xLjMzLjE0djIyLjM0WiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTI5Mi41MywxMzMuMzdoLTcuODJ2OC43NGg4Ljg1djUuNDhoLTE1LjU0di0zMi4zOGgxNC45N3Y1LjQ4aC04LjI4djcuNDRoNy44MnY1LjI0WiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTMxNi4wMywxMTUuMjF2MzIuMzhoLTYuNjl2LTMyLjM4aDYuNjlaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNMzIyLjkxLDE0Ny41OXYtMzIuMzhoNi4xNGw1LjMxLDEyLjY4YzEuMDcsMi41LDIuNzEsNi42OCwzLjY4LDkuNDZoLjFjLS4yLTMuNDEtLjY2LTkuMDMtLjY2LTE0Ljk4di03LjE2aDUuODh2MzIuMzhoLTYuMTNsLTUuMjYtMTIuM2MtMS4xOC0yLjc0LTIuNzEtNi44Ny0zLjUzLTkuNzVoLS4xYy4yMSwzLjI2LjQ3LDguMjYuNDcsMTQuOHY3LjI1aC01Ljg4WiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTM1NS4zOSwxNDcuNTlsLTcuNjYtMzIuMzhoNy40MWwyLjQ1LDEzLjk3Yy41NiwzLjUxLDEuMjgsNy40NSwxLjc0LDExLjI0aC4xMWMuNDYtMy44NCwxLjAyLTcuNzMsMS42NC0xMS4zOGwyLjM1LTEzLjg0aDcuMzZsLTcuODcsMzIuMzhoLTcuNTFaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNMzg5LjU4LDEzMy4zN2gtNy44MnY4Ljc0aDguODR2NS40OGgtMTUuNTN2LTMyLjM4aDE0Ljk3djUuNDhoLTguMjh2Ny40NGg3LjgydjUuMjRaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNMzk2LjM0LDExNS43YzIuMDktLjM5LDQuNzUtLjYzLDcuMzEtLjYzLDMuNjgsMCw3LC41Myw5LjIsMi40LDIuMDksMS43OCwyLjc2LDMuOTQsMi43Niw2LjcyLDAsMy40Ni0xLjg0LDYuNTgtNS4zMiw4LjA3di4xYzIuMzUuOTEsMy41MywyLjkzLDQuMTksNi40NC42NiwzLjYsMS41OSw3LjU5LDIuMiw4Ljc5aC03Yy0uNDYtLjkyLTEuMjMtNC4xOC0xLjc0LTcuNzgtLjYxLTMuOTgtMS42OC01LjE0LTMuODgtNS4xNGgtMS4wMnYxMi45MmgtNi42OXYtMzEuODlaTTQwMy4wNCwxMjkuODJoMS4yMmMyLjkxLDAsNC41NS0yLjIxLDQuNTUtNS4wNHMtMS4xNy00LjcxLTQuMTQtNC44MWMtLjYyLDAtMS4yOC4wNS0xLjYzLjE5djkuNjVaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNNDIxLjQzLDE0MS4xNWMxLjM4LjczLDMuNzgsMS4yNSw1LjY3LDEuMjUsMy4xMiwwLDQuNy0xLjUzLDQuNy0zLjY1LDAtMi4zNi0xLjU0LTMuNTEtNC40NS01LjI5LTQuNy0yLjY5LTYuNDktNi4xLTYuNDktOS4wMywwLTUuMTgsMy42OC05LjUxLDEwLjgzLTkuNTEsMi4zLDAsNC40NC41Nyw1LjQxLDEuMTVsLTEuMDcsNS40M2MtLjk3LS41OC0yLjQ1LTEuMTEtNC4zNC0xLjExLTIuODYsMC00LjI0LDEuNjQtNC4yNCwzLjM3LDAsMS45MiwxLjAyLDIuOTMsNC43LDUuMDQsNC42LDIuNiw2LjIzLDUuODYsNi4yMyw5LjI3LDAsNS45MS00LjY1LDkuOC0xMS4zNSw5LjgtMi43NiwwLTUuNDEtLjY4LTYuNTktMS4zbC45Ny01LjQzWiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTQ1MC4xMywxMTUuMjF2MzIuMzhoLTYuNjl2LTMyLjM4aDYuNjlaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNNDc3LjY5LDEzMC44M2MwLDEyLjE5LTQuNiwxNy4xNS0xMS4xNCwxNy4xNS03LjgyLDAtMTAuODktNy43OS0xMC44OS0xNi42N3MzLjc0LTE2LjQ3LDExLjQtMTYuNDdjOC4yOCwwLDEwLjYzLDguNTksMTAuNjMsMTZaTTQ2Mi42MiwxMzEuNGMwLDcuMzUsMS40OCwxMS4xLDQuMTksMTEuMSwyLjg2LDAsMy45NC00LjgsMy45NC0xMS4zOCwwLTUuNjctLjkyLTEwLjgyLTMuOTktMTAuODItMi42NSwwLTQuMTMsNC4xMy00LjEzLDExLjFaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNNDgzLjIsMTQ3LjU5di0zMi4zOGg2LjEzbDUuMzEsMTIuNjhjMS4wNywyLjUsMi43MSw2LjY4LDMuNjgsOS40NmguMTFjLS4yMS0zLjQxLS42Ny05LjAzLS42Ny0xNC45OHYtNy4xNmg1Ljg4djMyLjM4aC02LjE0bC01LjI2LTEyLjNjLTEuMTgtMi43NC0yLjcxLTYuODctMy41Mi05Ljc1aC0uMTFjLjIsMy4yNi40Niw4LjI2LjQ2LDE0Ljh2Ny4yNWgtNS44OFoiLz4NCiAgICA8cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik01MjUuMDgsMTMzLjM3aC03LjgydjguNzRoOC44NHY1LjQ4aC0xNS41M3YtMzIuMzhoMTQuOTd2NS40OGgtOC4yOHY3LjQ0aDcuODJ2NS4yNFoiLz4NCiAgICA8cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik01MzEuMzIsMTQxLjE1YzEuMzguNzMsMy43OCwxLjI1LDUuNjcsMS4yNSwzLjEyLDAsNC43LTEuNTMsNC43LTMuNjUsMC0yLjM2LTEuNTMtMy41MS00LjQ1LTUuMjktNC43LTIuNjktNi40OS02LjEtNi40OS05LjAzLDAtNS4xOCwzLjY4LTkuNTEsMTAuODMtOS41MSwyLjMsMCw0LjQ1LjU3LDUuNDEsMS4xNWwtMS4wNyw1LjQzYy0uOTctLjU4LTIuNDYtMS4xMS00LjM1LTEuMTEtMi44NiwwLTQuMjQsMS42NC00LjI0LDMuMzcsMCwxLjkyLDEuMDIsMi45Myw0LjcsNS4wNCw0LjYsMi42LDYuMjQsNS44Niw2LjI0LDkuMjcsMCw1LjkxLTQuNjUsOS44LTExLjM1LDkuOC0yLjc2LDAtNS40Mi0uNjgtNi41OS0xLjNsLjk3LTUuNDNaIi8+DQogICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNMTEyLjY0LDIyLjI5Yy00Ni42MywwLTg0LjQ0LDM3LjgtODQuNDQsODQuNDRzMzcuODEsODQuNDMsODQuNDQsODQuNDMsODQuNDMtMzcuOCw4NC40My04NC40M1MxNTkuMjcsMjIuMjksMTEyLjY0LDIyLjI5Wk04Mi41NywxMzEuMDljMi41MSwwLDUuMzctLjU0LDcuMTktMS4wN2wxLjQ5LDExLjgxYy0yLjE3Ljk3LTYuNCwxLjcyLTExLjU0LDEuNzItMTkuNzYsMC0yOS4xMy0xNS4xNC0yOS4xMy0zNS43NSwwLTI3LjI3LDE2LjExLTM3LjksMzEuMDctMzcuOSw1LjI1LDAsOC45MS45NywxMC4zOSwxLjkzbC0yLjUxLDExLjgxYy0xLjcxLS43NS0zLjY2LTEuNC02Ljk3LTEuNC04LjQ1LDAtMTYuMTEsNi44Ny0xNi4xMSwyNC44czYuOTcsMjQuMDUsMTYuMTEsMjQuMDVaTTEzNy40NCw4Mi43N2gtMTguNXYxOC41N2gxNy4zNnYxMS43aC0xNy4zNnYyOS44NWgtMTQuOTZ2LTcyLjM3aDMzLjQ3djEyLjI0Wk0xNjUuOTcsMTQyLjloLTE0Ljk2di03Mi4zN2gxNC45NnY3Mi4zN1oiLz4NCiAgICA8cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik0xNS45MSwxMDcuMzhjMCw0LjM5LTMuNTYsNy45Ni03Ljk2LDcuOTZzLTcuOTYtMy41Ni03Ljk2LTcuOTYsMy41Ni03Ljk1LDcuOTYtNy45NSw3Ljk2LDMuNTYsNy45Niw3Ljk1WiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTIyNS4yOCwxMDcuMzhjMCw0LjM5LTMuNTYsNy45Ni03Ljk2LDcuOTZzLTcuOTYtMy41Ni03Ljk2LTcuOTYsMy41Ni03Ljk1LDcuOTYtNy45NSw3Ljk2LDMuNTYsNy45Niw3Ljk1WiIvPg0KICAgIDxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTcuOTYsMTA2LjA1YzAsNTcuODIsNDYuODcsMTA0LjY5LDEwNC42OSwxMDQuNjlzMTA0LjY4LTQ2Ljg3LDEwNC42OC0xMDQuNjkiLz4NCiAgICA8cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik03Ljk2LDEwNy4zOUM3Ljk2LDQ5LjU3LDU0LjgzLDIuNywxMTIuNjQsMi43czEwNC42OCw0Ni44NywxMDQuNjgsMTA0LjY5Ii8+DQogIDwvZz4NCjwvc3ZnPg==' />
        </h1>
      </div>
      <div class="header-text-group" style="margin-left: auto;">
        <h1 style="margin-bottom: 0; color: #FFFFFF!important">Simulador de Cuotas de Créditos CFI</h1>
        <p style="margin: 0; opacity: 0.9;">Sistema alemán de amortización</p>
      </div>
    </div>

    <div class="card">
      <div class="help-uso-interno">
        Uso interno UEP. Resultados orientativos, no constituyen oferta ni instrumento oficial.
      </div>
      <div class="help-lineas"><strong>Competitividad PyME:</strong> fija 36% TNA hasta el mes 12; desde el 13 aplica
        TAMAR + 2. - <a href="https://cfi.org.ar/competitividad_pyme" target="_blank">Ver detalles</a></div>
      <div class="help-lineas"><strong>Financiamiento Verde:</strong> fija 27% TNA hasta el mes 24; luego TAMAR + 2. -
        <a href="https://cfi.org.ar/financiamiento_verde" target="_blank">Ver detalles</a>
      </div>
      <div class="help-lineas"><strong>Línea Mujeres:</strong> fija 27% TNA hasta el mes 24; luego TAMAR + 2. - <a
          href="https://cfi.org.ar/desarrollo_productivo_financiero_mujeres" target="_blank">Ver detalles</a></div>
      <div class="help-lineas help-ultima-linea"><strong>Triple Impacto:</strong> fija 21,6% TNA hasta el mes 24; luego
        TAMAR + 2. - <a href="https://cfi.org.ar/programas_abordaje_integral" target="_blank">Ver detalles</a></div>

      <div class="grid">
        <div>
          <label for="linea">Línea de crédito</label>
          <select id="linea">
            <option value="competitividad">Competitividad PyME</option>
            <option value="verde">Financiamiento Verde</option>
            <option value="mujeres">Mujeres</option>
            <option value="triple">Triple Impacto</option>
          </select>
        </div>

        <div>
          <label for="monto">Monto a financiar (en pesos)</label>
          <input id="monto" type="text" inputmode="numeric">
          <div class="help">
            Máximo según línea de financiamiento
          </div>
        </div>

        <div>
          <label for="plazo">Plazo total (meses)</label>
          <input id="plazo" type="number" min="1" max="48">
          <div class="help">Máximo 48/60 meses s/ línea.</div>
        </div>

        <div>
          <label for="gracia">Período de gracia (meses)</label>
          <input id="gracia" type="number" min="0" max="6">
          <div class="help">Máx. 6/12 meses. s/ línea.</div>
        </div>
      </div>

      <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

      <div class="grid">
        <div>
          <label for="frecuencia">Frecuencia de amortización</label>
          <select id="frecuencia">
            <option value="mensual">Mensual</option>
            <option value="trimestral">Trimestral</option>
            <option value="semestral">Semestral</option>
          </select>
          <div class="help">
            Define cada cuánto se pagan las cuotas (1, 3 o 6 meses).
          </div>
        </div>
        <div>
          <label for="tamarTna">Tasa TAMAR + 2 p.p. (%) - Se actualiza automáticamente -</label>
          <input id="tamarTna" type="number" min="0" step="0.01">
          <div class="help">Tasa anual variable</div>
        </div>
        <div>
          <label for="tamarFecha">Fecha TAMAR</label>
          <input id="tamarFecha" type="text" placeholder="dd/mm/aaaa">
          <div class="help">Informativa</div>
        </div>
      </div>

      <button id="btnSimular">Calcular cuadro de cuotas</button>
      <button id="btnExportar" class="secondary" disabled style="display: none;">Exportar a CSV (Excel)</button>
      <button id="btnImprimir" class="secondary" disabled>Exportar a PDF</button>
      <div id="error" class="error"></div>
    </div>

    <div class="card" id="resultCard" style="display:none;">
      <h2>Cuadro de cuotas</h2>
      <div id="resumen" class="summary"></div>
      <div id="tablaWrapper"></div>
      <div class="note" id="notaTamar"></div>
      <div class="note" id="notaLegal"></div>
    </div>
  </div>

  <script>
    // ============================
    // Configuración de líneas
    // ============================
    const lineConfigs = {
      competitividad: {
        nombre: "Competitividad PyME",
        min: 4000000,
        max: 100000000,
        tramoVariableDesdeMes: 13,
        tnaFijaTramo1: 0.36,
        plazoMax: 48,
        graciaMax: 6
      },
      verde: {
        nombre: "Financiamiento Verde",
        min: 0,
        max: 200000000,
        tramoVariableDesdeMes: 25,
        tnaFijaTramo1: 0.27,
        plazoMax: 60,
        graciaMax: 12
      },
      mujeres: {
        nombre: "Mujeres",
        min: 0,
        max: 200000000,
        tramoVariableDesdeMes: 25,
        tnaFijaTramo1: 0.27,
        plazoMax: 48,
        graciaMax: 12
      },
      triple: {
        nombre: "Triple Impacto",
        min: 0,
        max: 300000000,
        tramoVariableDesdeMes: 25,
        tnaFijaTramo1: 0.216,
        plazoMax: 60,
        graciaMax: 12
      }
    };

    // ============================
    // Utilitarios
    // ============================
    function formatearMonto(valor) {
      return valor.toLocaleString("es-AR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // (La dejamos por si en algún momento la querés usar)
    function tasaMensualDesdeTNA(tna) {
      return tna / 12;
    }

    // NUEVA: tasa del período en DECIMAL usando días y TNA (%)
    function obtenerTasaPeriodoDecimal(lineaKey, mesNumero, tamarTnaAplicada, diasPeriodo) {
      const cfg = lineConfigs[lineaKey];
      let tnaPorcentaje;

      if (mesNumero < cfg.tramoVariableDesdeMes) {
        // Tramo fijo de la línea (por ej. 36% para Competitividad)
        tnaPorcentaje = cfg.tnaFijaTramo1 * 100;
      } else {
        // Tramo TAMAR + 2 p.p.
        if (!tamarTnaAplicada || tamarTnaAplicada <= 0) {
          throw new Error("Para este plazo se requiere cargar la tasa TAMAR + 2 p.p. (TNA).");
        }
        tnaPorcentaje = tamarTnaAplicada;
      }

      // Fórmula pedida: tasaPeriodoDecimal = TNA(%) * dias / 36500
      const tasaPeriodoDecimal = (tnaPorcentaje * diasPeriodo) / 36500;
      return tasaPeriodoDecimal;
    }

    function formatearFechaDDMMYYYY(date) {
      const d = String(date.getDate()).padStart(2, "0");
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }

    let ultimaSimulacion = null;

    // ============================
    // API TAMAR – integración
    // ============================
    const API_URL = "https://prestamos.ikiwi.net.ar/api/tamars";

    function fechaHoy() {
      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0');
      const dd = String(hoy.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    async function obtenerTAMAR() {
      console.log("Obteniendo TAMAR desde API...");
      const inputTamar = document.getElementById("tamarTna");
      const inputFecha = document.getElementById("tamarFecha");
      const divError = document.getElementById("error");

      const hoy = fechaHoy();

      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        data.sort((a, b) => new Date(a.date) - new Date(b.date));

        let tamar = data.find(item => item.date === hoy);

        if (!tamar) {
          const anteriores = data.filter(item => item.date < hoy);
          if (anteriores.length > 0) {
            tamar = anteriores[anteriores.length - 1];
          }
        }

        if (tamar) {
          const valorBase = Number(tamar.value);
          if (!valorBase || isNaN(valorBase)) {
            throw new Error("El campo 'value' de TAMAR no es numérico: " + tamar.value);
          }

          const valorConDos = valorBase + 2;
          inputTamar.value = valorConDos.toFixed(3);

          const partesFecha = tamar.date.split('-');
          const fechaFormateada = `${partesFecha[2]}/${partesFecha[1]}/${partesFecha[0]}`;
          inputFecha.value = fechaFormateada;

          if (divError) divError.textContent = "";
        } else {
          throw new Error("No se encontraron datos para hoy ni días anteriores.");
        }

      } catch (error) {
        console.error("Error al obtener TAMAR:", error);

        if (divError) {
          divError.textContent =
            "No se pudo obtener la TAMAR desde el servicio. " +
            "Podés cargarla a mano. (Detalle: " + error + ")";
        }
      }
    }

    // ============================
    // Simulación
    // ============================
    function simular() {
      const lineaKey = document.getElementById("linea").value;
      const monto = Number(document.getElementById("monto").value.replace(/\./g, '') || 0);
      const plazo = parseInt(document.getElementById("plazo").value, 10);
      const gracia = parseInt(document.getElementById("gracia").value, 10);
      const frecuencia = document.getElementById("frecuencia").value;
      const tamarTna = document.getElementById("tamarTna").value
        ? Number(document.getElementById("tamarTna").value)
        : null;
      const tamarFecha = document.getElementById("tamarFecha").value.trim();

      const divError = document.getElementById("error");
      const resultCard = document.getElementById("resultCard");
      const tablaWrapper = document.getElementById("tablaWrapper");
      const resumenDiv = document.getElementById("resumen");
      const notaTamar = document.getElementById("notaTamar");
      const notaLegal = document.getElementById("notaLegal");
      const btnExportar = document.getElementById("btnExportar");
      const btnImprimir = document.getElementById("btnImprimir");

      divError.textContent = "";
      resultCard.style.display = "none";
      tablaWrapper.innerHTML = "";
      notaTamar.textContent = "";
      notaLegal.textContent = "";
      btnExportar.disabled = true;
      btnImprimir.disabled = true;
      ultimaSimulacion = null;

      if (!lineaKey || isNaN(monto) || isNaN(plazo) || isNaN(gracia)) {
        divError.textContent = "Por favor, ingresá todos los datos numéricos.";
        return;
      }

      const cfg = lineConfigs[lineaKey];

      if (monto < cfg.min || (cfg.max > 0 && monto > cfg.max)) {
        divError.textContent = "El monto ingresado está fuera del rango permitido para la línea seleccionada.";
        return;
      }

      if (plazo > cfg.plazoMax || plazo <= 0) {
        divError.textContent = "El plazo máximo permitido para la línea " + cfg.nombre + " es de " + cfg.plazoMax + " meses.";
        return;
      }

      if (gracia < 0 || gracia > cfg.graciaMax) {
        divError.textContent = "El período de gracia para " + cfg.nombre + " no puede ser mayor a " + cfg.graciaMax + " meses.";
        return;
      }

      if (gracia >= plazo) {
        divError.textContent = "El período de gracia debe ser menor al plazo total del crédito.";
        return;
      }

      if (!["mensual", "trimestral", "semestral"].includes(frecuencia)) {
        divError.textContent = "Frecuencia de amortización no válida.";
        return;
      }

      const mesesAmortizacion = plazo - gracia;
      let factorFrecuencia;
      if (frecuencia === "mensual") {
        factorFrecuencia = 1;
      } else if (frecuencia === "trimestral") {
        factorFrecuencia = 3;
      } else {
        factorFrecuencia = 6;
      }

      if (mesesAmortizacion <= 0) {
        divError.textContent = "El plazo menos la gracia debe ser mayor que cero.";
        return;
      }
      if (plazo % factorFrecuencia !== 0) {
        divError.textContent =
          "El plazo total (" + plazo + " meses) debe ser múltiplo de la frecuencia (" +
          factorFrecuencia + " meses).";
        return;
      }
      if (frecuencia !== "mensual" && gracia % factorFrecuencia !== 0) {
        divError.textContent =
          "Para la frecuencia " + frecuencia + ", el período de gracia (" + gracia +
          " meses) debe ser múltiplo de la frecuencia (" + factorFrecuencia + " meses).";
        return;
      }

      let saldo = monto;
      let totalIntereses = 0;
      let totalAmortizacion = 0;
      let totalCuotas = 0;
      let rows = [];

      let html = "<table>";
      html += "<thead><tr>" +
        "<th>Período</th>" +
        "<th>Tasa período (%)</th>" +
        "<th>Interés</th>" +
        "<th>Amortización</th>" +
        "<th>Cuota</th>" +
        "<th>Saldo</th>" +
        "</tr></thead><tbody>";

      try {
        if (frecuencia === "mensual") {
          // Un período = 30 días
          const diasPeriodo = 30;
          const amortizacionConstante = monto / mesesAmortizacion;

          for (let mes = 1; mes <= plazo; mes++) {
            const tasaPeriodoDecimal = obtenerTasaPeriodoDecimal(lineaKey, mes, tamarTna, diasPeriodo);
            const interes = saldo * tasaPeriodoDecimal;
            let amort = 0;

            if (mes > gracia) {
              amort = amortizacionConstante;
              if (mes === plazo) {
                amort = saldo; // ajuste final para que sume exactamente el capital
              }
            }

            const cuota = interes + amort;
            saldo -= amort;

            totalIntereses += interes;
            totalAmortizacion += amort;
            totalCuotas += cuota;

            const tasaPct = tasaPeriodoDecimal * 100;

            html += "<tr>" +
              `<td data-label="Período">${mes}</td>` +
              `<td data-label="Tasa (%)">${tasaPct.toFixed(4)}</td>` +
              `<td data-label="Interés">${formatearMonto(interes)}</td>` +
              `<td data-label="Amortización">${formatearMonto(amort)}</td>` +
              `<td data-label="Cuota">${formatearMonto(cuota)}</td>` +
              `<td data-label="Saldo">${formatearMonto(Math.max(saldo, 0))}</td>` +
              "</tr>";

            rows.push({
              periodo: mes,
              tasaPeriodoPct: tasaPct,
              interes,
              amort,
              cuota,
              saldo: Math.max(saldo, 0)
            });
          }

        } else {
          // Trimestral o semestral: mismo criterio de días (30 * factorFrecuencia)
          const numCuotasTotales = plazo / factorFrecuencia;
          const numCuotasAmortizacion = mesesAmortizacion / factorFrecuencia;
          const numPeriodosGracia = gracia / factorFrecuencia;

          const amortizacionConstante = monto / numCuotasAmortizacion;

          for (let n = 1; n <= numCuotasTotales; n++) {
            const mesDelPago = n * factorFrecuencia;
            const diasPeriodo = 30 * factorFrecuencia;

            const tasaPeriodoDecimal = obtenerTasaPeriodoDecimal(lineaKey, mesDelPago, tamarTna, diasPeriodo);
            const interes = saldo * tasaPeriodoDecimal;
            let amort = 0;

            if (n > numPeriodosGracia) {
              amort = amortizacionConstante;
              if (n === numCuotasTotales) {
                amort = saldo; // ajuste final
              }
            }

            const cuota = interes + amort;
            saldo -= amort;

            totalIntereses += interes;
            totalAmortizacion += amort;
            totalCuotas += cuota;

            const tasaPct = tasaPeriodoDecimal * 100;

            html += "<tr>" +
              `<td data-label="Período">${n}</td>` +
              `<td data-label="Tasa (%)">${tasaPct.toFixed(4)}</td>` +
              `<td data-label="Interés">${formatearMonto(interes)}</td>` +
              `<td data-label="Amortización">${formatearMonto(amort)}</td>` +
              `<td data-label="Cuota">${formatearMonto(cuota)}</td>` +
              `<td data-label="Saldo">${formatearMonto(Math.max(saldo, 0))}</td>` +
              "</tr>";

            rows.push({
              periodo: n,
              tasaPeriodoPct: tasaPct,
              interes,
              amort,
              cuota,
              saldo: Math.max(saldo, 0)
            });
          }
        }
      } catch (e) {
        divError.textContent = e.message;
        return;
      }

      html += "</tbody><tfoot><tr>" +
        "<td colspan=\"2\" data-label=\"Totales\">Totales</td>" +
        `<td data-label="Total Interés">${formatearMonto(totalIntereses)}</td>` +
        `<td data-label="Total Amort.">${formatearMonto(totalAmortizacion)}</td>` +
        `<td data-label="Total Cuota">${formatearMonto(totalCuotas)}</td>` +
        "<td data-label=\"Saldo Final\">0,00</td></tr></tfoot></table>";

      tablaWrapper.innerHTML = html;

      let textoFrecuencia = "Mensual";
      if (frecuencia === "trimestral") textoFrecuencia = "Trimestral";
      if (frecuencia === "semestral") textoFrecuencia = "Semestral";

      const cfgResumen = lineConfigs[lineaKey];

      resumenDiv.innerHTML =
        `Línea: <strong>${cfgResumen.nombre}</strong><br>` +
        `Monto: <strong>$${formatearMonto(monto)}</strong> — ` +
        `Plazo total: <strong>${plazo} meses</strong> — ` +
        `Período de gracia: <strong>${gracia} meses</strong> — ` +
        `Frecuencia de amortización: <strong>${textoFrecuencia}</strong><br>` +
        `Sistema: <strong>Alemán</strong> (amortización constante en cada cuota).`;

      const mesVariable = cfgResumen.tramoVariableDesdeMes;
      let textoTamar = "";

      if (mesVariable <= plazo) {
        textoTamar =
          `Desde el mes ${mesVariable}, las cuotas se calculan con la tasa TAMAR + 2 p.p. ` +
          `cargada en este simulador.`;

        if (tamarTna) {
          textoTamar += ` Tasa utilizada: ${tamarTna.toFixed(3)}% TNA`;
          if (tamarFecha) {
            textoTamar += ` (fecha TAMAR: ${tamarFecha}).`;
          } else {
            textoTamar += ".";
          }
        } else {
          textoTamar += " No se informó valor de TAMAR en esta simulación.";
        }
      }

      notaTamar.textContent = textoTamar;

      notaLegal.textContent =
        "Nota: Simulación orientativa. Las condiciones definitivas deben verificarse en el sitio oficial del CFI y con las áreas técnicas y crediticias correspondientes.";

      resultCard.style.display = "block";
      btnExportar.disabled = false;
      btnImprimir.disabled = false;

      ultimaSimulacion = {
        linea: cfgResumen.nombre,
        monto,
        plazo,
        gracia,
        frecuencia: textoFrecuencia,
        tamarTna,
        tamarFecha,
        rows,
        totalIntereses,
        totalAmortizacion,
        totalCuotas
      };
    }

    // ============================
    // Generar HTML para Excel
    // ============================
    function generarHTMLCompleto(simulacion) {
      const sim = simulacion;
      const today = new Date().toLocaleDateString("es-AR");

      let tablaHtml = "<table><thead><tr>" +
        "<th>Período</th><th>Tasa período (%)</th><th>Interés</th><th>Amortización</th><th>Cuota</th><th>Saldo</th>" +
        "</tr></thead><tbody>";

      sim.rows.forEach(r => {
        tablaHtml += "<tr>" +
          `<td>${r.periodo}</td>` +
          `<td style="text-align:right;">${r.tasaPeriodoPct.toFixed(4)}</td>` +
          `<td style="text-align:right;">${formatearMonto(r.interes)}</td>` +
          `<td style="text-align:right;">${formatearMonto(r.amort)}</td>` +
          `<td style="text-align:right;">${formatearMonto(r.cuota)}</td>` +
          `<td style="text-align:right;">${formatearMonto(Math.max(r.saldo, 0))}</td>` +
          "</tr>";
      });

      tablaHtml += "</tbody><tfoot><tr>" +
        `<td colspan="2" style="font-weight:bold;">Totales</td>` +
        `<td style="text-align:right; font-weight:bold;">${formatearMonto(sim.totalIntereses)}</td>` +
        `<td style="text-align:right; font-weight:bold;">${formatearMonto(sim.totalAmortizacion)}</td>` +
        `<td style="text-align:right; font-weight:bold;">${formatearMonto(sim.totalCuotas)}</td>` +
        "<td></td></tr></tfoot></table>";

      const html = `
    <html>
    <head>
        <meta charset="utf-8" />
        <style>
            body { font-family: Arial, sans-serif; }
            .header-info { margin-bottom: 20px; border-bottom: 2px solid #004aad; padding-bottom: 10px; }
            .header-info h2 { color: #004aad; margin-top: 0; }
            .logo { max-width: 150px; height: auto; float: right; margin-left: 20px; }
            .datos-credito p { margin: 4px 0; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10pt; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f0f0f2; font-weight: bold; text-align: center; }
            td:nth-child(n+3) { text-align: right; }
            tfoot td { background-color: #e0e0e6; font-weight: bold; }
        </style>
    </head>
    <body>

        <div class="header-info">
            <img src="./logo.jpeg" alt="Logo de la Empresa" class="logo">
            <h2>Simulación de Cuotas CFI - ${sim.linea}</h2>
            <div class="datos-credito">
                <p><strong>Monto:</strong> $${formatearMonto(sim.monto)}</p>
                <p><strong>Plazo Total:</strong> ${sim.plazo} meses</p>
                <p><strong>Gracia:</strong> ${sim.gracia} meses</p>
                <p><strong>Frecuencia:</strong> ${sim.frecuencia}</p>
                <p><strong>Sistema:</strong> Alemán (Amortización constante)</p>
                <p><strong>Tasa Variable (TAMAR+2 TNA):</strong> ${sim.tamarTna ? sim.tamarTna.toFixed(3) + '%' : 'N/A'}</p>
                <p><strong>Fecha de exportación:</strong> ${today}</p>
            </div>
            <div style="clear: both;"></div>
        </div>

        <h3>Cuadro de Amortización Detallado</h3>
        ${tablaHtml}
    </body>
    </html>
    `;
      return html;
    }

    function exportarXLS() {
      if (!ultimaSimulacion) return;

      const htmlContent = generarHTMLCompleto(ultimaSimulacion);

      const blob = new Blob(["\ufeff", htmlContent], { type: "application/vnd.ms-excel;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Cuadro_Cuotas_${ultimaSimulacion.linea.replace(/\s+/g, "")}_CFI.xls`;

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportarPDF() {
      if (!ultimaSimulacion) return;

      const { jsPDF } = window.jspdf;
      if (!jsPDF) {
        document.getElementById("error").textContent = "Error: La librería jsPDF no se cargó correctamente. No se puede generar el PDF.";
        return;
      }

      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });
      const sim = ultimaSimulacion;
      const margin = 15;
      let y = margin;

      const logoBase64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD...'; // tu logo
      const logoWidth = 70;
      const logoHeight = logoWidth / 6.25;
      const pageWidth = doc.internal.pageSize.getWidth();

      const azulOscuroCFI_R = 15;
      const azulOscuroCFI_G = 25;
      const azulOscuroCFI_B = 45;

      try {
        doc.addImage(logoBase64, 'PNG', margin, y, logoWidth, logoHeight);
      } catch (e) {
        console.warn("No se pudo cargar el logo en PDF:", e);
      }

      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text(`Fecha: ${new Date().toLocaleDateString("es-AR")}`, pageWidth - margin, y + 5, { align: 'right' });

      y = y + logoHeight + 15;

      doc.setFontSize(18);
      doc.setTextColor(azulOscuroCFI_R, azulOscuroCFI_G, azulOscuroCFI_B);
      doc.setFont(undefined, 'bold');
      doc.text(`Simulación de Cuotas CFI - ${sim.linea}`, margin, y);
      y += 10;

      doc.setDrawColor(azulOscuroCFI_R, azulOscuroCFI_G, azulOscuroCFI_B);
      doc.setLineWidth(0.8);
      doc.line(margin, y, pageWidth - margin, y);
      y += 8;

      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.setFont(undefined, 'normal');

      doc.text(`Monto: $${formatearMonto(sim.monto)} | Plazo Total: ${sim.plazo} meses | Gracia: ${sim.gracia} meses`, margin, y);
      y += 6;
      doc.text(`Frecuencia: ${sim.frecuencia} | Sistema: Alemán | Tasa Variable (TAMAR+2 TNA): ${sim.tamarTna ? sim.tamarTna.toFixed(3) + '%' : 'N/A'}`, margin, y);
      y += 10;

      doc.setFontSize(8);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(0, 0, 0);
      const disclaimerText = "La presente simulación tiene carácter meramente estimativo e informativo. Los valores proyectados no son definitivos ni vinculantes y no constituyen, bajo ningún concepto, la cuota final del crédito. El CFI no asume obligación alguna de otorgar un crédito con estas condiciones ni garantiza que las cuotas reales coincidan con los cálculos aquí exhibidos. Las condiciones financieras finales —incluyendo monto, tasa, plazo, sistema de amortización y valor de las cuotas— quedarán sujetas exclusivamente a la evaluación, aprobación y liquidación formal del crédito por parte del CFI.";
      const splitDisclaimer = doc.splitTextToSize(disclaimerText, pageWidth - (2 * margin));
      doc.text(splitDisclaimer, margin, y);
      y += (splitDisclaimer.length * 4) + 8;

      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');

      const head = [['Período', 'Tasa (%)', 'Interés', 'Amortización', 'Cuota', 'Saldo']];
      const body = sim.rows.map(r => [
        r.periodo.toString(),
        r.tasaPeriodoPct.toFixed(4),
        formatearMonto(r.interes),
        formatearMonto(r.amort),
        formatearMonto(r.cuota),
        formatearMonto(Math.max(r.saldo, 0))
      ]);

      doc.autoTable({
        head: head,
        body: body,
        startY: y,
        margin: { top: margin, bottom: margin, left: margin, right: margin },
        theme: 'striped',
        headStyles: {
          fillColor: [azulOscuroCFI_R, azulOscuroCFI_G, azulOscuroCFI_B],
          halign: 'center',
          fontSize: 9,
          fontStyle: 'bold'
        },
        styles: {
          fontSize: 8,
          cellPadding: 2.5,
          overflow: 'linebreak'
        },
        columnStyles: {
          0: { halign: 'center', cellWidth: 20 },
          1: { halign: 'right', cellWidth: 25 },
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' },
          5: { halign: 'right' },
        },
        didDrawPage: function (data) {
          const pageCount = doc.internal.getNumberOfPages();
          const currentPage = doc.internal.getCurrentPageInfo().pageNumber;

          if (currentPage === pageCount) {
            const finalY = data.cursor.y;
            const tableWidth = pageWidth - (2 * margin);

            doc.setFillColor(224, 224, 230);
            doc.rect(margin, finalY, tableWidth, 8, 'F');

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Totales', margin + 2, finalY + 5.5);
            doc.text(formatearMonto(sim.totalIntereses), margin + 70, finalY + 5.5, { align: 'right' });
            doc.text(formatearMonto(sim.totalAmortizacion), margin + 105, finalY + 5.5, { align: 'right' });
            doc.text(formatearMonto(sim.totalCuotas), margin + 140, finalY + 5.5, { align: 'right' });
          }

          doc.setFontSize(8);
          doc.setTextColor(128, 128, 128);
          doc.text(
            'Página ' + currentPage + ' de ' + pageCount,
            pageWidth - margin,
            doc.internal.pageSize.getHeight() - 10,
            { align: 'right' }
          );
        }
      });

      doc.save(`Simulacion_CFI_${sim.linea.replace(/\s+/g, '_')}.pdf`);
    }

    function exportarCSV() {
      if (!ultimaSimulacion) return;

      const sim = ultimaSimulacion;
      let csv = "";

      csv += "Linea," + sim.linea + "\n";
      csv += "Monto," + sim.monto + "\n";
      csv += "Plazo (meses)," + sim.plazo + "\n";
      csv += "Gracia (meses)," + sim.gracia + "\n";
      csv += "Frecuencia," + sim.frecuencia + "\n";
      if (sim.tamarTna) {
        csv += "TAMAR+2 TNA (%)," + sim.tamarTna + "\n";
        csv += "Fecha TAMAR," + (sim.tamarFecha || "") + "\n";
      }
      csv += "\n";
      csv += "Periodo,Tasa periodo (%),Interes,Amortizacion,Cuota,Saldo\n";

      sim.rows.forEach(r => {
        csv += [
          r.periodo,
          r.tasaPeriodoPct.toFixed(4),
          r.interes.toFixed(2),
          r.amort.toFixed(2),
          r.cuota.toFixed(2),
          r.saldo.toFixed(2)
        ].join(",") + "\n";
      });

      csv += "\n";
      csv += [
        "Totales",
        "",
        sim.totalIntereses.toFixed(2),
        sim.totalAmortizacion.toFixed(2),
        sim.totalCuotas.toFixed(2),
        ""
      ].join(",") + "\n";

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Cuadro_Cuotas_${sim.linea.replace(/\s+/g, "")}_${sim.monto}_CFI.csv`;

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById("btnSimular").addEventListener("click", simular);
    document.getElementById("btnExportar").addEventListener("click", exportarXLS);
    document.getElementById("btnImprimir").addEventListener("click", exportarPDF);

    window.addEventListener("DOMContentLoaded", obtenerTAMAR);

    document.getElementById("monto").addEventListener("input", function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value) {
        e.target.value = parseInt(value).toLocaleString('es-AR');
      } else {
        e.target.value = '';
      }
    });

    document.getElementById("monto").addEventListener("blur", function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value) {
        e.target.value = parseInt(value).toLocaleString('es-AR');
      }
    });
  </script>
</body>

</html>